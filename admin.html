
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      margin: 0;
    }
    h1, h2 { color: #E50914; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #333;
      text-align: left;
    }
    th { background: #1e1e1e; }
    tr:nth-child(even) { background: #1a1a1a; }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin: 2px;
    }
    .enable { background: #4CAF50; color: #fff; }
    .disable { background: #f44336; color: #fff; }
    .all-btn {
      margin: 10px 5px;
      padding: 10px 20px;
      border-radius: 6px;
    }
    input[type="file"], input[type="text"] {
      margin: 5px 0;
      padding: 6px;
    }
    #delete-apk {
      background: #FF4500;
      color: #fff;
      display: none;
      margin-left: 10px;
    }
    a.download-link {
      color: #4DA6FF;
      text-decoration: none;
      font-weight: bold;
    }
    a.download-link:hover {
      text-decoration: underline;
    }
    .analytics-table { margin-top: 40px; }
    #current-version-stamp {
      position: fixed;
      bottom: 5px;
      right: 10px;
      color: #4CAF50;
      font-size: 14px;
      font-weight: bold;
      background: rgba(0,0,0,0.3);
      padding: 4px 8px;
      border-radius: 4px;
    }
    #search-user {
      padding:6px;
      width: 300px;
      margin-bottom:10px;
      border-radius: 4px;
      border: 1px solid #333;
      background: #1e1e1e;
      color: #fff;
    }
    .delete-user-btn {
      background:#FF4500;
      color:#fff;
    }
  </style>
</head>
<body>

<div id="current-version-stamp">Version: -</div>

<h1>Admin Dashboard</h1>

<!-- APK Management -->
<h2>Upload New APK</h2>
<form id="upload-apk-form">
  <input type="file" id="apk-file" accept=".apk" required>
  <input type="text" id="apk-version" placeholder="Version (e.g., 1.0.1)" required>
  <button type="submit">Upload APK</button>
  <button type="button" id="delete-apk">Delete APK</button>
</form>
<p id="latest-apk" style="margin-top:10px;"></p>

<!-- User Management -->
<h2>Users Management</h2>
<input type="text" id="search-user" placeholder="Search by name or email...">
<br>
<button class="all-btn enable" id="enable-all">Enable All Users</button>
<button class="all-btn disable" id="disable-all">Disable All Users</button>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="users-tbody"></tbody>
</table>

<!-- Login Analytics -->
<h2>Login Analytics</h2>
<table class="analytics-table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Total Logins</th>
      <th>Last Login Timestamp (UTC)</th>
      <th>IP</th>
      <th>Country</th>
      <th>User-Agent</th>
    </tr>
  </thead>
  <tbody id="analytics-tbody"></tbody>
</table>

<script>
  // ----- Fetch and display users with optional search -----
  async function loadUsers(query = '') {
    const url = query ? `/admin_search_users?q=${encodeURIComponent(query)}` : '/get_users';
    const res = await fetch(url);
    const users = await res.json();
    const tbody = document.getElementById('users-tbody');
    tbody.innerHTML = '';

    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.name}</td>
        <td>${u.email}</td>
        <td>${u.enabled ? 'Enabled' : 'Disabled'}</td>
        <td>
          <button class="${u.enabled ? 'disable' : 'enable'}"
                  onclick="toggleUser('${u.email}', ${!u.enabled})">
            ${u.enabled ? 'Disable' : 'Enable'}
          </button>
          <button class="delete-user-btn"
                  onclick="deleteUser('${u.email}')">
            Delete
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ----- Delete a user -----
  async function deleteUser(email) {
    if(!confirm(`Delete user ${email}? This cannot be undone.`)) return;
    const res = await fetch('/admin_delete_user', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email})
    });
    const data = await res.json();
    if(data.success){
      alert('User deleted.');
      loadUsers(document.getElementById('search-user').value);
      loadAnalytics();
    } else alert(data.message || 'Error deleting user.');
  }

  // ----- Search users -----
  const searchInput = document.getElementById('search-user');
  searchInput.addEventListener('input', () => {
    loadUsers(searchInput.value.trim());
  });

  // ----- Toggle individual user -----
  async function toggleUser(email, enable) {
    await fetch('/toggle_user', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email, enable})
    });
    loadUsers(searchInput.value.trim());
    loadAnalytics();
  }

  // ----- Enable all / Disable all -----
  document.getElementById('enable-all').addEventListener('click', async () => {
    await fetch('/enable_all', {method:'POST'});
    loadUsers(searchInput.value.trim());
    loadAnalytics();
  });
  document.getElementById('disable-all').addEventListener('click', async () => {
    await fetch('/disable_all', {method:'POST'});
    loadUsers(searchInput.value.trim());
    loadAnalytics();
  });

  // ----- Show latest APK info -----
  async function loadLatestAPK() {
    const res = await fetch('/get_apk');
    const apk = await res.json();
    const p = document.getElementById('latest-apk');
    const delBtn = document.getElementById('delete-apk');
    const stamp = document.getElementById('current-version-stamp');

    if(apk.download_url) {
      p.innerHTML = `Latest APK: Version <b>${apk.version}</b> - 
        <a class="download-link" href="${apk.download_url}" download="app-latest.apk">Download</a>`;
      delBtn.style.display = 'inline-block';
      stamp.innerText = `Version: ${apk.version}`;
    } else {
      p.innerHTML = `No APK uploaded yet.`;
      delBtn.style.display = 'none';
      stamp.innerText = `Version: -`;
    }
  }

  // ----- Upload APK -----
  document.getElementById('upload-apk-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('apk-file');
    const versionInput = document.getElementById('apk-version');
    const file = fileInput.files[0];
    const version = versionInput.value.trim();
    if(!file || !version) return alert('File and version required.');

    const formData = new FormData();
    formData.append('apk', file);
    formData.append('version', version);

    const res = await fetch('/upload_apk', {method:'POST', body: formData});
    const data = await res.json();
    alert(data.message || (data.success ? "Uploaded" : "Error"));

    fileInput.value = '';
    versionInput.value = '';

    loadLatestAPK();
  });

  // ----- Delete APK -----
  document.getElementById('delete-apk').addEventListener('click', async () => {
    if(!confirm('Are you sure you want to delete the APK?')) return;
    const res = await fetch('/delete_apk', {method:'POST'});
    const data = await res.json();
    alert(data.message || (data.success ? "Deleted" : "Error"));
    loadLatestAPK();
  });

  // ----- Load login analytics -----
  async function loadAnalytics() {
    const res = await fetch('/login_analytics');
    const analytics = await res.json();
    const tbody = document.getElementById('analytics-tbody');
    tbody.innerHTML = '';

    analytics.forEach(u => {
      const last = u.last_login || {};
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.name}</td>
        <td>${u.email}</td>
        <td>${u.total_logins}</td>
        <td>${last.timestamp || '-'}</td>
        <td>${last.ip || '-'}</td>
        <td>${last.country || '-'}</td>
        <td>${last.user_agent || '-'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Initial load
  loadUsers();
  loadLatestAPK();
  loadAnalytics();
</script>

</body>
</html>
